<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="stylesheet" href="css/image.css" />
		<link rel="stylesheet" href="css/viewer.min.css">
		<title>Minecraft Image</title>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
		<script src="javascript/viewer.min.js"></script>
	</head>
	<body>
		<p>Websocket connected: <span id="ws_connected"></span></p>
		
		<div class="loading-bar">
            <div class="bar">
                <div id="bar"></div>
				<p id="percentage">0%</p>
            </div>
        </div>
		<div class="image-main">
			<div class="image-container">
				<img id="mc-image" />
			</div>
		</div>
		<img id='original-image' src=""/>
		<script>
			const StatusCodes = {
				starting: 0,
				running: 1,
				done: 2,
				error: 3,
			};

			const imageID = new URL(document.URL).searchParams.get("id");

			$('#original-image').attr('src', `/view?id=${imageID}&original=true`);

			const socket = new WebSocket(`ws://${document.location.host}/ws?id=${imageID}`);

			socket.addEventListener("message", (e) => {
				const msg = JSON.parse(e.data);
				console.log(msg);

				if (msg?.status === StatusCodes.done) {
					$("#mc-image").attr("src", `http://${document.location.host}/view?id=${imageID}`);
					const viewer = new Viewer(document.querySelector('#mc-image'), {
						
						button: false,
						navbar: false,
						toolbar: {
							zoomIn: true,
							zoomOut: true,
							oneToOne: true,
							reset: true,
							prev: false,
							play: {
							show: false,
							size: 'large',
							},
							next: false,
							rotateLeft: false,
							rotateRight: false,
							flipHorizontal: false,
							flipVertical: false,
						},
						movable: true,
						title: false,
						zoomRatio: 0.3,
						minZoomRatio: 0.05,

					});
					return;
				}
			});

			socket.addEventListener("error", (e) => {
				console.error(e);
			});

			socket.addEventListener("open", (e) => (document.querySelector("#ws_connected").innerText = "true"));
			socket.addEventListener("close", (e) => (document.querySelector("#ws_connected").innerText = "false"));
		
			function setBar(n) {
				const percentage = Math.min(Math.ceil(n), 100);
				document.querySelector("#bar").style.width = `${percentage}%`;
				$("#percentage").text(`${percentage}%`)
			}
		
		</script>
	</body>
</html>
